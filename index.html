let dqr = null;
let productqr = null;

const dqrScanner = new Html5Qrcode("scanner-dqr");
const productScanner = new Html5Qrcode("scanner-productqr");

let isScanning = false; // äºŒé‡ã‚¹ã‚­ãƒ£ãƒ³é˜²æ­¢

// ðŸŽ¯ ãƒœã‚¿ãƒ³æŠ¼ä¸‹ã§èª­ã¿å–ã‚Šé–‹å§‹ï¼ˆ1å›žé™å®šï¼‰
function startLeftScanner() {
  if (isScanning) return;
  isScanning = true;

  const qrboxSize = Math.min(window.innerWidth, 300); // æ­£æ–¹å½¢æž 
  dqrScanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: { width: qrboxSize, height: qrboxSize } },
    qr => {
      dqr = qr;
      dqrScanner.stop();
      isScanning = false;
      document.getElementById("result").textContent = "1å›žç›®QRèª­ã¿å–ã‚Šå®Œäº†ã€‚æ¬¡ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ã€‚";
    }
  ).catch(err => {
    console.error("å·¦ã‚¹ã‚­ãƒ£ãƒŠãƒ¼èµ·å‹•å¤±æ•—:", err);
    isScanning = false;
  });
}

function startRightScanner() {
  if (isScanning) return;
  isScanning = true;

  const qrboxSize = Math.min(window.innerWidth, 300);
  productScanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: { width: qrboxSize, height: qrboxSize } },
    qr => {
      productqr = qr;
      productScanner.stop();
      isScanning = false;
      checkMatch();
    }
  ).catch(err => {
    console.error("å³ã‚¹ã‚­ãƒ£ãƒŠãƒ¼èµ·å‹•å¤±æ•—:", err);
    isScanning = false;
  });
}

function checkMatch() {
  if (dqr && productqr) {
    fetch("https://script.google.com/macros/s/AKfycbzAfRJoFs9hy0-jw8GcY0egwmjA9dlE6WSXCVdMOiJcs44DnBPHpGmFaEw6FD_ZyVE-LA/exec", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: `dp=${encodeURIComponent(dqr)}&productQr=${encodeURIComponent(productqr)}`
    })
      .then(res => res.text())
      .then(result => {
        const resultBox = document.getElementById("result");
        resultBox.textContent = result;
        resultBox.className = result.includes("OK") ? "ok" : "ng";
      });
  }
}
