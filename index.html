let dqr = null;
let productqr = null;

const dqrScanner = new Html5Qrcode("scanner-dqr");
const productScanner = new Html5Qrcode("scanner-productqr");

let isScanning = false; // 二重スキャン防止

// 🎯 ボタン押下で読み取り開始（1回限定）
function startLeftScanner() {
  if (isScanning) return;
  isScanning = true;

  const qrboxSize = Math.min(window.innerWidth, 300); // 正方形枠
  dqrScanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: { width: qrboxSize, height: qrboxSize } },
    qr => {
      dqr = qr;
      dqrScanner.stop();
      isScanning = false;
      document.getElementById("result").textContent = "1回目QR読み取り完了。次をスキャンしてください。";
    }
  ).catch(err => {
    console.error("左スキャナー起動失敗:", err);
    isScanning = false;
  });
}

function startRightScanner() {
  if (isScanning) return;
  isScanning = true;

  const qrboxSize = Math.min(window.innerWidth, 300);
  productScanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: { width: qrboxSize, height: qrboxSize } },
    qr => {
      productqr = qr;
      productScanner.stop();
      isScanning = false;
      checkMatch();
    }
  ).catch(err => {
    console.error("右スキャナー起動失敗:", err);
    isScanning = false;
  });
}

function checkMatch() {
  if (dqr && productqr) {
    fetch("https://script.google.com/macros/s/AKfycbzAfRJoFs9hy0-jw8GcY0egwmjA9dlE6WSXCVdMOiJcs44DnBPHpGmFaEw6FD_ZyVE-LA/exec", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: `dp=${encodeURIComponent(dqr)}&productQr=${encodeURIComponent(productqr)}`
    })
      .then(res => res.text())
      .then(result => {
        const resultBox = document.getElementById("result");
        resultBox.textContent = result;
        resultBox.className = result.includes("OK") ? "ok" : "ng";
      });
  }
}
